# gemini_meihua_module.py

from typing import List, Dict, Tuple

# 卦象基本資料庫（key為長名）
HEXAGRAM_DB = {
    "乾為天": {"name": "乾為天", "judgement": "乾，元亨，利貞。", "lines": ["初九：潛龍勿用。", "九二：見龍在田，利見大人。", "九三：君子終日乾乾，夕惕若厲，無咎。", "九四：或躍在淵，無咎。", "九五：飛龍在天，利見大人。", "上九：亢龍有悔。"]},
    "坤為地": {"name": "坤為地", "judgement": "坤，元亨，利牝馬之貞。君子有攸往，先迷後得主，利西南得朋，東北喪朋。安貞吉。", "lines": ["初六：履霜，堅冰至。", "六二：直方大，不習無不利。", "六三：含章可貞，或從王事，無成有終。", "六四：括囊，無咎無譽。", "六五：黃裳，元吉。", "上六：龍戰于野，其血玄黃。"]},
    "水雷屯": {"name": "水雷屯", "judgement": "屯，元亨利貞，勿用有攸往，利建侯。", "lines": ["初九：磐桓，利居貞，利建侯。", "六二：屯如邅如，乘馬班如，匪寇婚媾，女子貞不字，十年乃字。", "六三：即鹿無虞，惟入于林中，君子幾不如舍，往吝。", "六四：乘馬班如，求婚媾，往吉，無不利。", "九五：屯其膏，小貞吉，大貞凶。", "上六：乘馬班如，泣血漣如。"]},
    "山水蒙": {"name": "山水蒙", "judgement": "蒙，亨。匪我求童蒙，童蒙求我。初筮告，再三瀆，瀆則不告。利貞。", "lines": ["初六：發蒙，利用刑人，用說桎梏，以往吝。", "九二：包蒙，吉。納婦，吉。子克家。", "六三：勿用取女，見金夫，不有躬，無攸利。", "六四：困蒙，吝。", "六五：童蒙，吉。", "上六：擊蒙，不利為寇，利禦寇。"]},
    "水天需": {"name": "水天需", "judgement": "需，有孚，光亨，貞吉。利涉大川。", "lines": ["初九：需于郊，利用恆，無咎。", "九二：需于沙，小有言，終吉。", "九三：需于泥，致寇至。", "六四：需于血，出自穴。", "九五：需于酒食，貞吉。", "上六：入于穴，有不速之客三人來，敬之終吉。"]},
    "天水訟": {"name": "天水訟", "judgement": "訟，有孚，窒惕，中吉，終凶。利見大人，不利涉大川。", "lines": ["初六：不永所事，小有言，終吉。", "九二：不克訟，歸而逋，其邑人三百戶，無眚。", "六三：食舊德，貞厲，終吉，或從王事，無成。", "九四：不克訟，復即命，渝安貞，吉。", "九五：訟，元吉。", "上九：或錫之鞶帶，終朝三褫之。"]},
    "地水師": {"name": "地水師", "judgement": "師，貞，丈人吉，無咎。", "lines": ["初六：師出以律，否臧凶。", "九二：在師中，吉，無咎，王三錫命。", "六三：師或輿尸，凶。", "六四：師左次，無咎。", "六五：田有禽，利執言，無咎。長子帥師，弟子輿尸，貞凶。", "上六：大君有命，開國承家，小人勿用。"]},
    "水地比": {"name": "水地比", "judgement": "比，吉。原筮，元永貞，無咎。不寧方來，後夫凶。", "lines": ["初六：有孚比之，無咎。有孚盈缶，終來有他，吉。", "六二：比之自內，貞吉。", "六三：比之匪人。", "六四：外比之，貞吉。", "九五：顯比，王用三驅，失前禽，邑人不誡，吉。", "上六：比之無首，凶。"]},
    "風天小畜": {"name": "風天小畜", "judgement": "小畜，亨。密雲不雨，自我西郊。", "lines": ["初九：復自道，何其咎，吉。", "九二：牽復，吉。", "九三：輿說輹，夫妻反目。", "六四：有孚，血去惕出，無咎。", "九五：有孚攣如，富以其鄰。", "上九：既雨既處，尚德載，婦貞厲。月幾望，君子征凶。"]},
    "天澤履": {"name": "天澤履", "judgement": "履虎尾，不咥人，亨。", "lines": ["初九：素履，往無咎。", "九二：履道坦坦，幽人貞吉。", "六三：眇能視，跛能履，履虎尾，咥人，凶。武人為于大君。", "九四：履虎尾，愬愬終吉。", "九五：夬履，貞厲。", "上九：視履考祥，其旋元吉。"]},
    "地天泰": {"name": "地天泰", "judgement": "泰，小往大來，吉，亨。", "lines": ["初九：拔茅茹，以其彙，征吉。", "九二：包荒，用馮河，不遐遺，朋亡，得尚于中行。", "九三：無平不陂，無往不復，艱貞無咎。勿恤其孚，于食有福。", "六四：翩翩不富，以其鄰，不戒以孚。", "六五：帝乙歸妹，以祉元吉。", "上六：城復于隍，勿用師。自邑告命，貞吝。"]},
    "天地否": {"name": "天地否", "judgement": "否之匪人，不利君子貞，大往小來。", "lines": ["初六：拔茅茹，以其彙，貞吉，亨。", "六二：包承，小人吉，大人否亨。", "六三：包羞。", "九四：有命無咎，疇離祉。", "九五：休否，大人吉。其亡其亡，繫于苞桑。", "上九：傾否，先否後喜。"]},
    "天火同人": {"name": "天火同人", "judgement": "同人于野，亨。利涉大川，利君子貞。", "lines": ["初九：同人于門，無咎。", "六二：同人于宗，吝。", "九三：伏戎于莽，升其高陵，三歲不興。", "九四：乘其墉，弗克攻，吉。", "六五：同人，先號咷而後笑，大師克，相遇。", "上九：同人于郊，無悔。"]},
    "火天大有": {"name": "火天大有", "judgement": "大有，元亨。", "lines": ["初九：無交害，匪咎，艱則無咎。", "九二：大車以載，有攸往，無咎。", "九三：公用亨于天子，小人弗克。", "九四：匪其彭，無咎。", "六五：厥孚交如，威如，吉。", "上九：自天祐之，吉無不利。"]},
    "地山謙": {"name": "地山謙", "judgement": "謙，亨，君子有終。", "lines": ["初六：謙謙君子，用涉大川，吉。", "六二：鳴謙，貞吉。", "九三：勞謙君子，有終，吉。", "六四：無不利，撝謙。", "六五：不富以其鄰，利用侵伐，無不利。", "上六：鳴謙，利用行師，征邑國。"]},
    "雷地豫": {"name": "雷地豫", "judgement": "豫，利建侯行師。", "lines": ["初六：鳴豫，凶。", "六二：介于石，不終日，貞吉。", "六三：盱豫，悔，遲有悔。", "九四：由豫，大有得，勿疑。朋盍簪。", "六五：貞疾，恆不死。", "上六：冥豫，成有渝，無咎。"]},
    "澤雷隨": {"name": "澤雷隨", "judgement": "隨，元亨利貞，無咎。", "lines": ["初九：官有渝，貞吉。出門交有功。", "六二：係小子，失丈夫。", "六三：係丈夫，失小子。隨有求得，利居貞。", "九四：隨有獲，貞凶。有孚在道，以明，何咎。", "九五：孚于嘉，吉。", "上六：拘係之，乃從維之。王用亨于西山。"]},
    "山風蠱": {"name": "山風蠱", "judgement": "蠱，元亨，利涉大川。先甲三日，後甲三日。", "lines": ["初六：幹父之蠱，有子，考無咎，厲終吉。", "九二：幹母之蠱，不可貞。", "九三：幹父之蠱，小有悔，無大咎。", "六四：裕父之蠱，往見吝。", "六五：幹父之蠱，用譽。", "上九：不事王侯，高尚其事。"]},
    "地澤臨": {"name": "地澤臨", "judgement": "臨，元亨，利貞。至于八月有凶。", "lines": ["初九：咸臨，貞吉。", "九二：咸臨，吉，無不利。", "六三：甘臨，無攸利。既憂之，無咎。", "六四：至臨，無咎。", "六五：知臨，大君之宜，吉。", "上六：敦臨，吉，無咎。"]},
    "風地觀": {"name": "風地觀", "judgement": "觀，盥而不薦，有孚顒若。", "lines": ["初六：童觀，小人無咎，君子吝。", "六二：窺觀，利女貞。", "六三：觀我生，進退。", "六四：觀國之光，利用賓于王。", "九五：觀我生，君子無咎。", "上九：觀其生，君子無咎。"]},
    "火雷噬嗑": {"name": "火雷噬嗑", "judgement": "噬嗑，亨。利用獄。", "lines": ["初九：屨校滅趾，無咎。", "九二：噬膚滅鼻，無咎。", "六三：噬臘肉，遇毒，小吝，無咎。", "九四：噬乾胏，得金矢，利艱貞，吉。", "六五：噬乾肉，得黃金，貞厲，無咎。", "上九：何校滅耳，凶。"]},
    "山火賁": {"name": "山火賁", "judgement": "賁，亨。小利有攸往。", "lines": ["初九：賁其趾，舍車而徒。", "六二：賁其須。", "九三：賁如濡如，永貞吉。", "六四：賁如皤如，白馬翰如，匪寇婚媾。", "六五：賁于丘園，束帛戔戔，吝，終吉。", "上九：白賁，無咎。"]},
    "山地剝": {"name": "山地剝", "judgement": "剝，不利有攸往。", "lines": ["初六：剝床以足，蔑貞凶。", "六二：剝床以辨，蔑貞凶。", "六三：剝之，無咎。", "六四：剝床以膚，凶。", "六五：貫魚，以宮人寵，無不利。", "上九：碩果不食，君子得輿，小人剝廬。"]},
    "地雷復": {"name": "地雷復", "judgement": "復，亨。出入無疾，朋來無咎。反復其道，七日來復，利有攸往。", "lines": ["初九：不遠復，無祗悔，元吉。", "六二：休復，吉。", "六三：頻復，厲，無咎。", "六四：中行獨復。", "六五：敦復，無悔。", "上六：迷復，凶，有災眚。用行師，終有大敗，以其國君凶，至于十年不克征。"]},
    "天雷無妄": {"name": "天雷無妄", "judgement": "無妄，元亨利貞。其匪正有眚，不利有攸往。", "lines": ["初九：無妄，往吉。", "六二：不耕穫，不菑畬，則利有攸往。", "六三：無妄之災，或繫之牛，行人之得，邑人之災。", "九四：可貞，無咎。", "九五：無妄之疾，勿藥有喜。", "上六：無妄，行有眚，無攸利。"]},
    "山天大畜": {"name": "山天大畜", "judgement": "大畜，利貞，不家食吉，利涉大川。", "lines": ["初九：有厲，利已。", "九二：輿說輹。", "九三：良馬逐，利艱貞。日閑輿衛，利有攸往。", "六四：童牛之牿，元吉。", "六五：豶豕之牙，吉。", "上九：何天之衢，亨。"]},
    "山雷頤": {"name": "山雷頤", "judgement": "頤，貞吉。觀頤，自求口實。", "lines": ["初九：舍爾靈龜，觀我朵頤，凶。", "六二：顛頤，拂經，于丘頤，征凶。", "六三：拂頤，貞凶，十年勿用，無攸利。", "六四：顛頤，吉。虎視眈眈，其欲逐逐，無咎。", "六五：拂經，居貞吉，不可涉大川。", "上九：由頤，厲吉，利涉大川。"]},
    "澤風大過": {"name": "澤風大過", "judgement": "大過，棟橈，利有攸往，亨。", "lines": ["初六：藉用白茅，無咎。", "九二：枯楊生稊，老夫得其女妻，無不利。", "九三：棟橈，凶。", "九四：棟隆，吉，有它吝。", "九五：枯楊生華，老婦得其士夫，無咎無譽。", "上六：過涉滅頂，凶，無咎。"]},
    "坎為水": {"name": "坎為水", "judgement": "習坎，有孚，維心亨，行有尚。", "lines": ["初六：習坎，入于坎窞，凶。", "九二：坎有險，求小得。", "六三：來之坎坎，險且枕，入于坎窞，勿用。", "六四：樽酒簋貳，用缶，納約自牖，終無咎。", "九五：坎不盈，祗既平，無咎。", "上六：係用徽纆，置于叢棘，三歲不得，凶。"]},
    "離為火": {"name": "離為火", "judgement": "離，利貞，亨。畜牝牛，吉。", "lines": ["初九：履錯然，敬之，無咎。", "六二：黃離，元吉。", "九三：日昃之離，不鼓缶而歌，則大耋之嗟，凶。", "九四：突如其來如，焚如，死如，棄如。", "六五：出涕沱若，戚嗟若，吉。", "上九：王用出征，有嘉折首，獲匪其醜，無咎。"]},
    "澤山咸": {"name": "澤山咸", "judgement": "咸，亨，利貞，取女吉。", "lines": ["初六：咸其拇。", "六二：咸其腓，凶，居吉。", "九三：咸其股，執其隨，往吝。", "九四：貞吉悔亡，憧憧往來，朋從爾思。", "九五：咸其脢，無悔。", "上六：咸其輔，頰，舌。"]},
    "雷風恆": {"name": "雷風恆", "judgement": "恆，亨，無咎，利貞，利有攸往。", "lines": ["初六：浚恆，貞凶，無攸利。", "九二：悔亡。", "九三：不恆其德，或承之羞，貞吝。", "九四：田無禽。", "六五：恆其德，貞，婦人吉，夫子凶。", "上六：振恆，凶。"]},
    "天山遁": {"name": "天山遁", "judgement": "遁，亨，小利貞。", "lines": ["初六：遁尾，厲，勿用有攸往。", "六二：執之用黃牛之革，莫之勝說。", "九三：係遁，有疾厲，畜臣妾吉。", "九四：好遁，君子吉，小人否。", "九五：嘉遁，貞吉。", "上九：肥遁，無不利。"]},
    "雷天大壯": {"name": "雷天大壯", "judgement": "大壯，利貞。", "lines": ["初九：壯于趾，征凶，有孚。", "九二：貞吉。", "九三：小人用壯，君子用罔，貞厲。羝羊觸藩，羸其角。", "九四：貞吉悔亡，藩決不羸，壯于大輿之輹。", "九五：喪羊于易，無悔。", "上九：羝羊觸藩，不能退，不能遂，無攸利，艱則吉。"]},
    "火地晉": {"name": "火地晉", "judgement": "晉，康侯用錫馬蕃庶，晝日三接。", "lines": ["初六：晉如，摧如，貞吉。罔孚，裕無咎。", "六二：晉如，愁如，貞吉。受茲介福，于其王母。", "六三：眾允，悔亡。", "九四：晉如鼫鼠，貞厲。", "六五：悔亡，失得勿恤，往吉，無不利。", "上九：晉其角，維用伐邑，厲吉無咎，貞吝。"]},
    "地火明夷": {"name": "地火明夷", "judgement": "明夷，利艱貞。", "lines": ["初九：明夷于飛，垂其翼。君子于行，三日不食，有攸往，主人有言。", "六二：明夷，夷于左股，用拯馬壯，吉。", "九三：明夷于南狩，得其大首，不可疾貞。", "六四：入于左腹，獲明夷之心，于出門庭。", "六五：箕子之明夷，利貞。", "上六：不明晦，初登于天，後入于地。"]},
    "風火家人": {"name": "風火家人", "judgement": "家人，利女貞。", "lines": ["初九：閑有家，悔亡。", "六二：無攸遂，在中饋，貞吉。", "九三：家人嗃嗃，悔厲吉；婦子嘻嘻，終吝。", "六四：富家，大吉。", "九五：王假有家，勿恤，吉。", "上九：有孚威如，終吉。"]},
    "火澤睽": {"name": "火澤睽", "judgement": "睽，小事吉。", "lines": ["初九：悔亡，喪馬勿逐，自復；見惡人，無咎。", "九二：遇主于巷，無咎。", "六三：見輿曳，其牛掣，其人天且劓，無初有終。", "九四：睽孤，遇元夫，交孚，厲無咎。", "六五：悔亡，厥宗噬膚，往何咎。", "上九：睽孤，見豕負塗，載鬼一車，先張之弧，後說之弧，匪寇婚媾，往遇雨則吉。"]},
    "水山蹇": {"name": "水山蹇", "judgement": "蹇，利西南，不利東北。利見大人，貞吉。", "lines": ["初六：往蹇，來譽。", "六二：王臣蹇蹇，匪躬之故。", "九三：往蹇，來反。", "六四：往蹇，來連。", "九五：大蹇，朋來。", "上六：往蹇，來碩，吉，利見大人。"]},
    "雷水解": {"name": "雷水解", "judgement": "解，利西南，無所往，其來復吉。有攸往，夙吉。", "lines": ["初六：無咎。", "九二：田獲三狐，得黃矢，貞吉。", "六三：負且乘，致寇至，貞吝。", "九四：解而拇，朋至斯孚。", "六五：君子維有解，吉，有孚于小人。", "上九：公用射隼于高墉之上，獲之，無不利。"]},
    "山澤損": {"name": "山澤損", "judgement": "損，有孚，元吉，無咎，可貞，利有攸往。曷之用，二簋可用享。", "lines": ["初九：已事遄往，無咎，酌損之。", "九二：利貞，征凶，弗損益之。", "六三：三人行，則損一人；一人行，則得其友。", "六四：損其疾，使遄有喜，無咎。", "六五：或益之十朋之龜，弗克違，元吉。", "上九：弗損益之，無咎，貞吉，利有攸往，得臣無家。"]},
    "風雷益": {"name": "風雷益", "judgement": "益，利有攸往，利涉大川。", "lines": ["初九：利用為大作，元吉，無咎。", "六二：或益之十朋之龜，弗克違，永貞吉。王用享于帝，吉。", "六三：益之用凶事，無咎。有孚中行，告公用圭。", "六四：中行，告公從。利用為依遷國。", "九五：有孚惠心，勿問元吉。有孚惠我德。", "上六：莫益之，或擊之，立心勿恆，凶。"]},
    "澤天夬": {"name": "澤天夬", "judgement": "夬，揚于王庭，孚號，有厲，告自邑，不利即戎，利有攸往。", "lines": ["初九：壯于前趾，往不勝為咎。", "九二：惕號，莫夜有戎，勿恤。", "九三：壯于頄，有凶。君子夬夬，獨行遇雨，若濡有慍，無咎。", "九四：臀無膚，其行次且。牽羊悔亡，聞言不信。", "九五：莧陸夬夬，中行無咎。", "上六：無號，終有凶。"]},
    "天風姤": {"name": "天風姤", "judgement": "姤，女壯，勿用取女。", "lines": ["初六：繫于金柅，貞吉，有攸往，見凶，羸豕孚蹢躅。", "九二：包有魚，無咎，不利賓。", "九三：臀無膚，其行次且，厲，無大咎。", "九四：包無魚，起凶。", "九五：以杞包瓜，含章，有隕自天。", "上九：姤其角，吝，無咎。"]},
    "澤地萃": {"name": "澤地萃", "judgement": "萃，亨。王假有廟，利見大人，亨，利貞。用大牲吉，利有攸往。", "lines": ["初六：有孚不終，乃亂乃萃，若號，一握為笑，勿恤，往無咎。", "六二：引吉，無咎，孚乃利用禴。", "六三：萃如，嗟如，無攸利，往無咎，小吝。", "九四：大吉，無咎。", "九五：萃有位，無咎。匪孚，元永貞，悔亡。", "上六：齎咨涕洟，無咎。"]},
    "地風升": {"name": "地風升", "judgement": "升，元亨，用見大人，勿恤，南征吉。", "lines": ["初六：允升，大吉。", "九二：孚乃利用禴，無咎。", "九三：升虛邑。", "六四：王用亨于岐山，吉，無咎。", "六五：貞吉，升階。", "上六：冥升，利于不息之貞。"]},
    "澤水困": {"name": "澤水困", "judgement": "困，亨，貞，大人吉，無咎。有言不信。", "lines": ["初六：臀困于株木，入于幽谷，三歲不覿。", "九二：困于酒食，朱紱方來，利用享祀。征凶，無咎。", "六三：困于石，據于蒺藜，入于其宮，不見其妻，凶。", "九四：來徐徐，困于金車，吝，有終。", "九五：劓刖，困于赤紱，乃徐有說，利用祭祀。", "上六：困于葛藟，于臲卼，曰動悔。有悔，征吉。"]},
    "水風井": {"name": "水風井", "judgement": "井，改邑不改井，無喪無得，往來井井。汔至，亦未繘井，羸其瓶，凶。", "lines": ["初六：井泥不食，舊井無禽。", "九二：井谷射鮒，甕敝漏。", "九三：井渫不食，為我心惻，可用汲，王明，並受其福。", "六四：井甃，無咎。", "九五：井冽，寒泉食。", "上六：井收勿幕，有孚元吉。"]},
    "震為雷": {"name": "震為雷", "judgement": "震，亨。震來虩虩，笑言啞啞。震驚百里，不喪匕鬯。", "lines": ["初九：震來虩虩，後笑言啞啞，吉。", "六二：震來厲，億喪貝，躋于九陵，勿逐，七日得。", "六三：震蘇蘇，震行無眚。", "九四：震遂泥。", "六五：震往來厲，億無喪，有事。", "上六：震索索，視矍矍，征凶。震不于其躬，于其鄰，無咎。婚媾有言。"]},
    "艮為山": {"name": "艮為山", "judgement": "艮其背，不獲其身，行其庭，不見其人，無咎。", "lines": ["初六：艮其趾，無咎，利永貞。", "六二：艮其腓，不拯其隨，其心不快。", "九三：艮其限，列其夤，厲薰心。", "六四：艮其身，無咎。", "六五：艮其輔，言有序，悔亡。", "上九：敦艮，吉。"]},
    "風山漸": {"name": "風山漸", "judgement": "漸，女歸吉，利貞。", "lines": ["初六：鴻漸于干，小子厲，有言，無咎。", "六二：鴻漸于磐，飲食衎衎，吉。", "九三：鴻漸于陸，夫征不復，婦孕不育，凶；利禦寇。", "六四：鴻漸于木，或得其桷，無咎。", "九五：鴻漸于陵，婦三歲不孕，終莫之勝，吉。", "上九：鴻漸于逵，其羽可用為儀，吉。"]},
    "雷澤歸妹": {"name": "雷澤歸妹", "judgement": "歸妹，征凶，無攸利。", "lines": ["初九：歸妹以娣，跛能履，征吉。", "九二：眇能視，利幽人之貞。", "六三：歸妹以須，反歸以娣。", "九四：歸妹愆期，遲歸有時。", "六五：帝乙歸妹，其君之袂，不如其娣之袂良。月幾望，吉。", "上六：女承筐無實，士刲羊無血，無攸利。"]},
    "雷火豐": {"name": "雷火豐", "judgement": "豐，亨，王假之，勿憂，宜日中。", "lines": ["初九：遇其配主，雖旬無咎，往有尚。", "六二：豐其蔀，日中見斗，往得疑疾，有孚發若，吉。", "九三：豐其沛，日中見沬，折其右肱，無咎。", "九四：豐其蔀，日中見斗，遇其夷主，吉。", "六五：來章，有慶譽，吉。", "上六：豐其屋，蔀其家，窺其戶，闃其無人，三歲不覿，凶。"]},
    "火山旅": {"name": "火山旅", "judgement": "旅，小亨，旅貞吉。", "lines": ["初六：旅瑣瑣，斯其所取災。", "六二：旅即次，懷其資，得童僕貞。", "九三：旅焚其次，喪其童僕，貞厲。", "九四：旅于處，得其資斧，我心不快。", "六五：射雉一矢亡，終以譽命。", "上九：鳥焚其巢，旅人先笑後號咷。喪牛于易，凶。"]},
    "巽為風": {"name": "巽為風", "judgement": "巽，小亨，利有攸往，利見大人。", "lines": ["初六：進退，利武人之貞。", "九二：巽在床下，用史巫紛若，吉，無咎。", "九三：頻巽，吝。", "六四：悔亡，田獲三品。", "九五：貞吉悔亡，無不利。無初有終，先庚三日，後庚三日，吉。", "上六：巽在床下，喪其資斧，貞凶。"]},
    "兌為澤": {"name": "兌為澤", "judgement": "兌，亨，利貞。", "lines": ["初九：和兌，吉。", "九二：孚兌，吉，悔亡。", "六三：來兌，凶。", "九四：商兌未寧，介疾有喜。", "九五：孚于剝，有厲。", "上六：引兌。"]},
    "風水渙": {"name": "風水渙", "judgement": "渙，亨。王假有廟，利涉大川，利貞。", "lines": ["初六：用拯馬壯，吉。", "九二：渙奔其機，悔亡。", "六三：渙其躬，無悔。", "六四：渙其群，元吉。渙有丘，匪夷所思。", "九五：渙汗其大號，渙王居，無咎。", "上九：渙其血，去逖出，無咎。"]},
    "水澤節": {"name": "水澤節", "judgement": "節，亨。苦節，不可貞。", "lines": ["初九：不出戶庭，無咎。", "九二：不出門庭，凶。", "六三：不節若，則嗟若，無咎。", "六四：安節，亨。", "九五：甘節，吉，往有尚。", "上六：苦節，貞凶，悔亡。"]},
    "風澤中孚": {"name": "風澤中孚", "judgement": "中孚，豚魚吉，利涉大川，利貞。", "lines": ["初九：虞吉，有它不燕。", "九二：鳴鶴在陰，其子和之，我有好爵，吾與爾靡之。", "六三：得敵，或鼓或罷，或泣或歌。", "六四：月幾望，馬匹亡，無咎。", "九五：有孚攣如，無咎。", "上九：翰音登于天，貞凶。"]},
    "雷山小過": {"name": "雷山小過", "judgement": "小過，亨，利貞，可小事，不可大事。飛鳥遺之音，不宜上，宜下，大吉。", "lines": ["初六：飛鳥以凶。", "六二：過其祖，遇其妣；不及其君，遇其臣，無咎。", "九三：弗過防之，從或戕之，凶。", "九四：無咎，弗過遇之。往厲必戒，勿用永貞。", "六五：密雲不雨，自我西郊，公弋取彼在穴。", "上六：弗遇過之，飛鳥離之，凶，是謂災眚。"]},
    "水火既濟": {"name": "水火既濟", "judgement": "既濟，亨，小利貞，初吉終亂。", "lines": ["初九：曳其輪，濡其尾，無咎。", "六二：婦喪其茀，勿逐，七日得。", "九三：高宗伐鬼方，三年克之，小人勿用。", "六四：繻有衣袽，終日戒。", "九五：東鄰殺牛，不如西鄰之禴祭，實受其福。", "上六：濡其首，厲。"]},
    "火水未濟": {"name": "火水未濟", "judgement": "未濟，亨，小狐汔濟，濡其尾，無攸利。", "lines": ["初六：濡其尾，吝。", "九二：曳其輪，貞吉。", "六三：未濟，征凶，利涉大川。", "九四：貞吉，悔亡，震用伐鬼方，三年有賞于大國。", "六五：貞吉，無悔，君子之光，有孚，吉。", "上九：有孚于飲酒，無咎，濡其首，有孚失是。"]},
    "澤火革": {"name": "澤火革", "judgement": "革，己日乃孚，元亨利貞，悔亡。", "lines": ["初九：鞏用黃牛之革。", "六二：己日乃革之，征吉，無咎。", "九三：征凶，貞厲；革言三就，有孚。", "九四：悔亡，有孚改命，吉。", "九五：大人虎變，未占有孚。", "上六：君子豹變，小人革面，征凶，居貞吉。"]},
    "火風鼎": {"name": "火風鼎", "judgement": "鼎，元吉，亨。", "lines": ["初六：鼎顛趾，利出否，得妾以其子，無咎。", "九二：鼎有實，我仇有疾，不我能即，吉。", "九三：鼎耳革，其行塞，雉膏不食，方雨虧悔，終吉。", "九四：鼎折足，覆公餗，其形渥，凶。", "六五：鼎黃耳金鉉，利貞。", "上九：鼎玉鉉，大吉，無不利。"]}
}

# 將六爻數字轉換為卦名（修正版 v5 - 外部驗證版）
# 六爻從下往上輸入，0=陰爻，1=陽爻
HEXAGRAM_MAP = {
    (1, 1, 1, 1, 1, 1): "乾為天",
    (0, 0, 0, 0, 0, 0): "坤為地",
    (1, 0, 0, 0, 1, 0): "水雷屯",
    (0, 1, 0, 0, 0, 1): "山水蒙",
    (1, 1, 1, 0, 1, 0): "水天需",
    (0, 1, 0, 1, 1, 1): "天水訟",
    (0, 0, 0, 0, 1, 0): "地水師",
    (0, 0, 0, 0, 1, 0): "水地比",
    (1, 1, 1, 0, 1, 1): "風天小畜",
    (1, 1, 0, 1, 1, 1): "天澤履",
    (1, 1, 1, 0, 0, 0): "地天泰",
    (0, 0, 0, 1, 1, 1): "天地否",
    (1, 0, 1, 1, 1, 1): "天火同人",
    (1, 1, 1, 1, 0, 1): "火天大有",
    (0, 0, 1, 0, 0, 0): "地山謙",
    (0, 0, 0, 1, 0, 0): "雷地豫",
    (1, 0, 0, 1, 1, 0): "澤雷隨",
    (0, 1, 1, 0, 0, 1): "山風蠱",
    (1, 1, 0, 0, 0, 0): "地澤臨",
    (0, 0, 0, 0, 1, 1): "風地觀",
    (1, 0, 0, 1, 0, 1): "火雷噬嗑",
    (1, 0, 1, 0, 0, 1): "山火賁",
    (0, 0, 0, 0, 0, 1): "山地剝",
    (1, 0, 0, 0, 0, 0): "地雷復",
    (1, 0, 0, 1, 1, 1): "天雷無妄",
    (1, 1, 1, 0, 0, 1): "山天大畜",
    (1, 0, 0, 0, 0, 1): "山雷頤",
    (0, 1, 1, 1, 1, 0): "澤風大過",
    (0, 1, 0, 0, 1, 0): "坎為水",
    (1, 0, 1, 1, 0, 1): "離為火",
    (0, 0, 1, 1, 1, 0): "澤山咸",
    (0, 1, 1, 1, 0, 0): "雷風恆",
    (0, 0, 1, 1, 1, 1): "天山遁",
    (1, 1, 1, 1, 0, 0): "雷天大壯",
    (0, 0, 0, 1, 0, 1): "火地晉",
    (1, 0, 1, 0, 0, 0): "地火明夷",
    (1, 0, 1, 0, 1, 1): "風火家人",
    (1, 1, 0, 1, 0, 1): "火澤睽",
    (0, 0, 1, 0, 1, 0): "水山蹇",
    (0, 1, 0, 1, 0, 0): "雷水解",
    (1, 1, 0, 1, 0, 1): "山澤損",
    (1, 0, 0, 0, 1, 1): "風雷益",
    (1, 1, 1, 1, 1, 0): "澤天夬",
    (0, 1, 1, 1, 1, 1): "天風姤",
    (0, 0, 0, 1, 1, 0): "澤地萃",
    (0, 1, 1, 0, 0, 0): "地風升",
    (0, 1, 0, 1, 1, 0): "澤水困",
    (0, 1, 0, 0, 1, 1): "風水渙",
    (1, 0, 1, 1, 1, 0): "澤火革",
    (0, 1, 1, 1, 0, 1): "火風鼎",
    (1, 0, 0, 1, 0, 0): "震為雷",
    (0, 0, 1, 0, 0, 1): "艮為山",
    (0, 0, 1, 0, 1, 1): "風山漸",
    (1, 1, 0, 1, 0, 0): "雷澤歸妹",
    (1, 0, 1, 1, 0, 0): "雷火豐",
    (0, 0, 1, 1, 0, 1): "火山旅",
    (0, 1, 1, 0, 1, 1): "巽為風",
    (1, 1, 0, 1, 1, 0): "兌為澤",
    (0, 1, 1, 0, 1, 0): "水風井",
    (1, 1, 0, 0, 1, 0): "水澤節",
    (1, 1, 0, 0, 1, 1): "風澤中孚",
    (0, 0, 1, 1, 0, 0): "雷山小過",
    (1, 0, 1, 0, 1, 0): "水火既濟",
    (0, 1, 0, 1, 0, 1): "火水未濟",
}

def get_hexagram_from_lines(lines: Tuple[int, ...]) -> str:
    """輸入六爻（自下而上），回傳卦名"""
    return HEXAGRAM_MAP.get(lines, "未知卦")

def interpret_hexagrams_from_lines(lines: List[int], moving_line_index: int = None) -> Dict[str, Dict]:
    """由六爻數字直接算出本卦、互卦、變卦解讀"""
    main_hexagram_name = get_hexagram_from_lines(tuple(lines))

    # --- 實作通用演算法 ---
    # 1. 計算互卦
    # 互卦由本卦的二、三、四爻為下卦，三、四、五爻為上卦組成
    # 組合方式為 [2,3,4,3,4,5]
    mutual_lines_list = lines[1:4] + lines[2:5]
    mutual_hexagram_name = get_hexagram_from_lines(tuple(mutual_lines_list))

    # 2. 計算變卦
    if moving_line_index is not None and 1 <= moving_line_index <= 6:
        changing_lines = list(lines)
        # 爻變：0變1，1變0
        changing_lines[moving_line_index - 1] = 1 - changing_lines[moving_line_index - 1]
        changing_hexagram_name = get_hexagram_from_lines(tuple(changing_lines))
    else:
        changing_hexagram_name = main_hexagram_name # 若無動爻，變卦即本卦

    def package(name: str) -> Dict:
        # 直接使用get，如果找不到，回傳預設值
        data = HEXAGRAM_DB.get(name)
        if data:
            return data
        return {"name": name, "judgement": "未知", "explanation": "資料庫未收錄", "lines": []}

    return {
        "本卦": package(main_hexagram_name),
        "互卦": package(mutual_hexagram_name),
        "變卦": package(changing_hexagram_name)
    }
